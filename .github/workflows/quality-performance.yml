name: Quality & Performance Checks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  docker-quality:
    name: Docker Configuration Validation
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Docker Compose Validation
        run: |
          echo "üê≥ Validating Docker configuration..."
          docker compose config
          echo "‚úÖ Docker Compose configuration is valid"
          
      - name: Dockerfile Syntax Check
        run: |
          echo "üîç Checking Dockerfile syntax..."
          
          # Check backend Dockerfile
          if [ -f "backend/employee/Dockerfile" ]; then
            echo "‚úÖ Backend Dockerfile found"
            docker run --rm -i hadolint/hadolint < backend/employee/Dockerfile || echo "‚ö†Ô∏è Hadolint suggestions (non-blocking)"
          fi
          
          # Check frontend Dockerfile
          if [ -f "frontend/employee/Dockerfile" ]; then
            echo "‚úÖ Frontend Dockerfile found"
            docker run --rm -i hadolint/hadolint < frontend/employee/Dockerfile || echo "‚ö†Ô∏è Hadolint suggestions (non-blocking)"
          fi
          
      - name: Docker Build Dry Run
        run: |
          echo "üèóÔ∏è Testing Docker build without execution..."
          
          # Just validate that docker compose can parse and plan the build
          echo "Docker build plan:"
          docker compose build --dry-run || echo "‚ö†Ô∏è Build planning completed with warnings"
          
          echo "‚úÖ Docker build validation completed"

  integration-quality:
    name: Integration Quality Check
    runs-on: ubuntu-latest
    needs: [docker-quality]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Docker Compose Validation
        run: |
          echo "üê≥ Validating Docker configuration..."
          
          # Check if docker compose files are valid
          docker compose config
          
          # Check for common issues
          echo "üìã Docker configuration analysis:"
          
          # Check for exposed secrets
          if grep -r "password\|secret\|key" docker compose.yml docker compose.*.yml 2>/dev/null | grep -v "SECRET_KEY_FILE\|PASSWORD_FILE"; then
            echo "‚ö†Ô∏è  Potential secrets in Docker files (review these):"
            grep -r "password\|secret\|key" docker compose.yml docker compose.*.yml 2>/dev/null | grep -v "SECRET_KEY_FILE\|PASSWORD_FILE"
          fi
          
          # Check for production-ready configurations
          if ! grep -q "restart:" docker compose.yml 2>/dev/null; then
            echo "‚ö†Ô∏è  Consider adding restart policies for production"
          fi
          
          echo "‚úÖ Docker configuration validated"
          
      - name: Environment Configuration Check
        run: |
          echo "üîß Checking environment configuration..."
          
          # Check for .env.example
          if [ -f ".env.example" ]; then
            echo "‚úÖ Environment example file found"
          else
            echo "‚ö†Ô∏è  No .env.example file found. Consider adding one for setup instructions"
          fi
          
          # Check for sensitive files in git
          if [ -f ".env" ]; then
            echo "‚ùå .env file found in repository! This should be in .gitignore"
            exit 1
          fi
          
          echo "‚úÖ Environment configuration check passed"

  performance-summary:
    name: Performance Summary
    runs-on: ubuntu-latest
    needs: [docker-quality, integration-quality]
    if: always()
    
    steps:
      - name: Performance Summary
        run: |
          echo "üìä Quality & Performance Check Summary"
          echo "=================================="
          
          # Check job statuses
          docker_status="${{ needs.docker-quality.result }}"
          integration_status="${{ needs.integration-quality.result }}"
          
          echo "Docker Quality: $docker_status"
          echo "Integration Quality: $integration_status"
          
          # Overall status
          if [ "$docker_status" = "success" ] && [ "$integration_status" = "success" ]; then
            echo ""
            echo "üéâ All quality & performance checks passed!"
            echo "‚úÖ Code is ready for deployment"
          else
            echo ""
            echo "‚ùå Some quality checks failed"
            echo "üîß Please review and fix the issues above"
            exit 1
          fi